<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper 
	PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN"
	"http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="com.picflower.dao.IboardDAO">

      <!-- 1. 후기글 목록 보기 (상품명 p_title 추가 연동) -->
    <select id="b_listWithMemberDao" resultType="com.picflower.dto.boardDTO">
        SELECT b.*, m.m_id, p.p_title, p.p_image
        FROM Board b 
        INNER JOIN member m ON b.m_no = m.m_no 
        LEFT JOIN product p ON b.p_no = p.p_no
        WHERE b.b_status = 1
        ORDER BY b.b_no DESC
    </select>
		<select id="getRecentProduct" resultType="com.picflower.dto.boardDTO">
		    SELECT * FROM (
		        SELECT p.p_no, p.p_title, p.p_image
		        FROM orders o
		        JOIN order_detail od ON o.o_no = od.o_no
		        JOIN product p ON od.p_no = p.p_no
		        WHERE o.m_no = #{m_no}
		        ORDER BY p.p_no DESC -- 혹은 최신 등록순
		    ) <![CDATA[ WHERE ROWNUM <= 3 ]]>
		</select>

    <!-- 2. 후기 글 입력 (b_status 기본값 1 추가) -->
    <insert id="b_insertDao">
        INSERT INTO board (b_no, b_date, b_image, b_text, b_rating, b_like, m_no, p_no, b_status)
        VALUES (board_seq.NEXTVAL, SYSDATE, #{b_image, jdbcType=VARCHAR}, #{b_text}, #{b_rating}, 0, #{m_no}, #{p_no}, 1)
    </insert>

    <!-- 3. 특정 게시글 상세 보기 (상품명 p_title 포함) -->
    <select id="b_viewWithMemberDao" resultType="com.picflower.dto.boardDTO">
        SELECT b.*, m.m_id, p.p_title 
        FROM board b
        INNER JOIN member m ON b.m_no = m.m_no
        LEFT JOIN product p ON b.p_no = p.p_no
        WHERE b.b_no = #{b_no}
    </select>

    <!-- 4. 좋아요 관련 쿼리들 -->
    <select id="checkLikeDao" resultType="int">
        SELECT COUNT(*) FROM board_like 
        WHERE b_no = #{b_no} AND m_no = #{m_no}
    </select>

    <insert id="insertLikeDao">
        INSERT INTO board_like (l_no, b_no, m_no, l_date)
        VALUES (board_like_seq.NEXTVAL, #{b_no}, #{m_no}, SYSDATE)
    </insert>

    <select id="getLikeCount" resultType="int">
        SELECT b_like FROM board WHERE b_no = #{b_no}
    </select>

    <update id="upLike">
        UPDATE board SET b_like = b_like + 1 WHERE b_no = #{b_no}
    </update>

    <delete id="deleteLikeDao">
        DELETE FROM board_like WHERE b_no = #{b_no} AND m_no = #{m_no}
    </delete>

    <update id="downLike">
        UPDATE board SET b_like = b_like - 1 WHERE b_no = #{b_no}
    </update>

    <!-- 5. 후기 수정 -->
    <update id="b_updateDao">
        UPDATE board SET
            b_text = #{b_text},
            b_rating = #{b_rating}
            <if test="b_image != null">
                , b_image = #{b_image, jdbcType=VARCHAR}
            </if>
        WHERE b_no = #{b_no}
    </update>

    <!-- 6. 실제 삭제 -->
    <delete id="b_deleteDao">
        DELETE FROM board WHERE b_no = #{b_no}
    </delete>
    
    <!-- 7. 논리 삭제 (상태값 변경) -->
    <update id="updateStatusDao">
        UPDATE board 
        SET b_status = 0 
        WHERE b_no = #{b_no}
    </update>
    
	<select id="b_listByProductDao" resultType="com.picflower.dto.boardDTO">
	    SELECT b.*, m.m_id, p.p_title, p.p_image
	    FROM board b
	    INNER JOIN member m ON b.m_no = m.m_no
	    LEFT JOIN product p ON b.p_no = p.p_no
	    WHERE b.b_status = 1 
	      AND b.p_no = #{p_no} 
	    ORDER BY b.b_no DESC
	</select>
	
	<select id="getUnreviewedProducts" resultType="com.picflower.dto.productDTO">
    SELECT p.p_no, p.p_title, p.p_image
    FROM product p
    JOIN order_detail od ON p.p_no = od.p_no
    JOIN orders o ON od.o_no = o.o_no
    WHERE o.m_no = #{m_no}
      AND NOT EXISTS (
          SELECT 1 
          FROM board b 
          WHERE b.p_no = p.p_no 
            AND b.m_no = #{m_no}
            AND b.b_status = 1
      )
    GROUP BY p.p_no, p.p_title, p.p_image
</select>
</mapper>