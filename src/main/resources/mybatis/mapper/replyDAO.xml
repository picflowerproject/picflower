<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper 
	PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN"
	"http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="com.picflower.dao.IreplyDAO">
    
    <!-- 1. 댓글 목록 조회: member 테이블과 JOIN하여 m_id를 가져옴 -->
    <select id="r_listByB_no" resultType="com.picflower.dto.replyDTO">
        SELECT r.*, m.m_id 
        FROM reply r
        JOIN member m ON r.m_no = m.m_no 
        WHERE r.b_no = #{b_no} 
        ORDER BY r.r_no DESC
    </select>

    <!-- 2. 댓글 저장: selectKey를 추가하여 생성된 번호를 DTO에 담아줍니다. -->
	<insert id="r_insertDao">
	    <selectKey keyProperty="r_no" resultType="int" order="BEFORE">
	        SELECT reply_seq.nextval FROM DUAL
	    </selectKey>
	    
	    INSERT INTO reply(r_no, r_text, r_count, r_date, b_no, m_no)
	    VALUES (#{r_no}, #{r_text}, #{r_count}, SYSDATE, #{b_no}, #{m_no})
	</insert>

    <!-- 3. 권한 확인을 위해 댓글 상세 조회 추가 (선택사항이나 권장) -->
    <select id="findByR_no" resultType="com.picflower.dto.replyDTO">
        SELECT r.*, m.m_id 
        FROM reply r
        JOIN member m ON r.m_no = m.m_no 
        WHERE r.r_no = #{r_no}
    </select>

    <!-- 나머지 update, delete는 기존과 동일 -->
    <update id="r_updateDao">
        UPDATE reply SET r_text=#{r_text}, r_date = SYSDATE
        WHERE r_no=#{r_no}
    </update>
    
    <delete id="r_deleteDao">
        DELETE FROM reply WHERE r_no=#{r_no}
    </delete>
</mapper>
