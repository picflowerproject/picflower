<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">

<mapper namespace="com.picflower.dao.IproductDAO">

    <!-- 1. 목록 조회 -->
    <select id="productListDao" resultType="com.picflower.dto.productDTO">
        SELECT * FROM product     
        <where>
            p_status = '판매중'
            <if test="p_category != null">
                AND p_category = #{p_category}
            </if>
        </where>
        ORDER BY p_no desc;
    </select>
    
    <!-- 2. 상품 등록 -->
    <insert id="productWriteDao">
        INSERT INTO product (p_no, p_title, p_subtitle, p_price, p_stock, p_category, p_image, p_detail, p_date, m_no, h_no, p_status)
        VALUES (product_seq.nextval, #{p_title}, #{p_subtitle}, #{p_price}, #{p_stock}, #{p_category}, #{p_image}, #{p_detail}, sysdate, #{m_no}, null, '판매중' )
    </insert>

    <!-- 3. 상세 보기 -->
    <select id="productViewDao" resultType="com.picflower.dto.productDTO">
        SELECT 
            p.*,
            (SELECT COUNT(*) FROM board b WHERE b.p_no = p.p_no AND b.b_status = 1) as review_count,
            (SELECT NVL(ROUND(AVG(b_rating), 1), 0) FROM board b WHERE b.p_no = p.p_no AND b.b_status = 1) as avg_rating
        FROM product p
        WHERE p.p_no = #{p_no}
    </select>
    
    <update id="productUpdateDao">
        UPDATE product SET p_title = #{p_title}, p_subtitle = #{p_subtitle}, p_price = #{p_price}, p_stock = #{p_stock}, p_category= #{p_category}, p_image = #{p_image}, p_detail = #{p_detail} WHERE p_no = #{p_no}
    </update>

    <!-- 4. 상품 삭제(상태값 변경) -->
    <update id="productDeleteDao">
        UPDATE product SET p_status = '삭제됨' WHERE p_no = #{param1}
    </update>
    
    <!-- 5. 페이징 목록 (중복 제거 및 서브쿼리 통합 완료) -->
   <select id="productListPagedDao" resultType="com.picflower.dto.productDTO">
	    SELECT * FROM (
	        SELECT rownum rnum, p.* FROM (
	            SELECT 
	                p.p_no, p.p_title, p.p_subtitle, p.p_price, p.p_stock, p.p_category, p.p_image, p.p_detail, p.p_date, p.m_no, p.h_no, p.p_status,
	                (SELECT COUNT(*) FROM board b WHERE b.p_no = p.p_no AND b.b_status = 1) as review_count,
	                (SELECT NVL(ROUND(AVG(b_rating), 1), 0) FROM board b WHERE b.p_no = p.p_no AND b.b_status = 1) as avg_rating
	            FROM product p
	            WHERE p.p_status = '판매중'
	            <if test="p_category != null and p_category != ''">
	                AND p.p_category = #{p_category}
	            </if>
	            ORDER BY p.p_no ASC  <!-- DESC에서 ASC로 변경 (기존 순서) -->
	        ) p
	        WHERE rownum &lt;= #{end}
	    ) 
	    WHERE rnum &gt;= #{start}
	</select>
    
    <!-- 6. 전체 개수 -->
    <select id="getTotalCountDao" resultType="int">
        SELECT COUNT(*) FROM product
        WHERE p_status = '판매중'
        <if test="p_category != null and p_category != ''">
            AND p_category = #{p_category}
        </if>
    </select>
    
    <!-- 상세페이지 전용 평점 쿼리 (필요 시 유지) -->
    <select id="productDetailWithRating" resultType="com.picflower.dto.productDTO">
        SELECT 
            p.*,
            (SELECT COUNT(*) FROM board b WHERE b.p_no = p.p_no AND b.b_status = 1) as review_count,
            (SELECT NVL(ROUND(AVG(b_rating), 1), 0) FROM board b WHERE b.p_no = p.p_no AND b.b_status = 1) as avg_rating
        FROM product p
        WHERE p.p_no = #{p_no}
    </select>

</mapper>